
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>InstaHelp</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/claat-public/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14" ga4id=""></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  codelab-ga4id=""
                  id="docs"
                  title="InstaHelp"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="About the App" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="First-Time Setup" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Technical Details" duration="0">
        <p>main.dart</p>
<pre><code language="language-dart" class="language-dart">import &#39;dart:io&#39;;

import &#39;package:flutter/material.dart&#39;;
import &#39;package:flutter/services.dart&#39;;

import &#39;package:porcupine_flutter/porcupine_error.dart&#39;;
import &#39;package:porcupine_flutter/porcupine_manager.dart&#39;;

import &#39;package:flutter_sms/flutter_sms.dart&#39;;
import &#39;package:just_audio/just_audio.dart&#39;;
import &#39;package:permission_handler/permission_handler.dart&#39;;
import &#39;package:torch_light/torch_light.dart&#39;;

import &#39;map_page.dart&#39;;
import &#39;profile_page.dart&#39;;

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // ensures app stays in portrait mode
  SystemChrome.setPreferredOrientations( [DeviceOrientation.portraitUp] );

  // ensures firebase features work
  await firebaseClass.initializeFirebase();

  runApp( const InstaHelp() );
}

class InstaHelp extends StatefulWidget {
  const InstaHelp({super.key});

  @override
  State&lt;InstaHelp&gt; createState() =&gt; _InstaHelpState();
}

class _InstaHelpState extends State&lt;InstaHelp&gt; {

  String _message = &#34;We&#39;re ready to help!&#34;;
  bool _muted = false;

  // Implementation of Porcupine Wake Word by Picovoice
  late PorcupineManager _porcupineManager;
  final _platform = Platform.isAndroid ? &#34;android&#34; : &#34;ios&#34;;
  static const _accessKey = String.fromEnvironment(&#34;picovoice&#34;, defaultValue: &#34;none&#34;);

  Future&lt;void&gt; _createPorcupineManager() async {
    try {
      _porcupineManager = await PorcupineManager.fromKeywordPaths(
        _accessKey,
        [
          &#34;assets/get-away-from-me_en_${_platform}_v3_0_0.ppn&#34;,
          &#34;assets/leave-me-alone_en_${_platform}_v3_0_0.ppn&#34;,
          &#34;assets/somebody-help_en_${_platform}_v3_0_0.ppn&#34;,
        ],
        _wakeWordCallback,
      );

      await _porcupineManager.start();
    } on PorcupineException {
      // handle any errors
    }
  }

  // features to run when call for help detected
  void _wakeWordCallback(keywordIndex) {
    setState( () =&gt; _message = &#34;Help is on the way!&#34; );
    if( userData.getTextMessageAlert() ) _sendTextMessageAlert();
    if( userData.getSoundAlarm() ) _playSoundAlarm();
    if( userData.getBlinkFlashlight() ) _startBlinkingFlashlight();
  }

  Future&lt;void&gt; _sendTextMessageAlert() async {

    List&lt;String&gt; recipients = [];

    for( int i = 0; i &lt; userData.getEmergencyContacts().length; i++ ) {
      recipients.add(
        String.fromCharCodes( // extracts phone number
          userData.getEmergencyContacts()[i].toString().codeUnits.where( (x) =&gt; (x ^0x30) &lt;= 9 )
        ) 
      );
    }

    await getPosition();
    try {
        await sendSMS(
          message: &#34;InstaHelp alert! ${firebaseClass.currentUser.displayName == null ||
            firebaseClass.currentUser.displayName!.replaceAll(&#34; &#34;, &#34;&#34;).isEmpty ?
            &#34;Someone&#34; : firebaseClass.currentUser.displayName} needs your help at &#34;
            &#34;www.google.com/maps/search/${currentPosition.latitude},${currentPosition.longitude}&#34;
            &#34;/@${currentPosition.latitude},${currentPosition.longitude}! &#34;
            &#34;${userData.getMedicalInfo() ? &#34;Blood Type: ${userData.getBloodType()}&#34; : &#34;&#34; }&#34;,
          recipients: recipients,
          sendDirect: true,
        );
    } on Error {
      // handle sending text message error
    }
  }

  final _player = AudioPlayer()..setAsset(&#34;assets/siren.wav&#34;)..setLoopMode(LoopMode.one);
  Future&lt;void&gt; _playSoundAlarm() async {
    await _player.seek( const Duration( seconds: 0 ), ); // reset to beginning of sound effect
    await _player.play();
  }

  Future&lt;void&gt; _startBlinkingFlashlight() async {
    final isTorchAvailable = await TorchLight.isTorchAvailable();
    if( isTorchAvailable ) {
      while( !_muted ) {
        await TorchLight.enableTorch();
        await Future.delayed( Duration( milliseconds: userData.getBlinkSpeed().round(), ), );
        await TorchLight.disableTorch();
        await Future.delayed( Duration( milliseconds: userData.getBlinkSpeed().round(), ), );
      } 
    }
  }

  // determines if all required permissions have been granted
  PermissionStatus _mapPermStatus = PermissionStatus.denied;
  PermissionStatus _micPermStatus = PermissionStatus.denied;
  PermissionStatus _smsPermStatus = PermissionStatus.denied;

  // updates all permission variables with current device permissions
  Future&lt;void&gt; _checkAllPermissions() async {
    final newMapPermStatus = await Permission.location.status;
    final newMicPermStatus = await Permission.microphone.status;
    final newSmsPermStatus = await Permission.sms.status;
    setState(() {
      _mapPermStatus = newMapPermStatus;
      _micPermStatus = newMicPermStatus;
      _smsPermStatus = newSmsPermStatus;
    });
  }
  
  // requests for all permissions required
  Future&lt;void&gt; _requestAllPermissions() async {
    await Permission.location.request().then( (value) async {
      await Permission.microphone.request().then( (value) async {
        await Permission.sms.request().then( (value) async {
          await _checkAllPermissions();
          await _createPorcupineManager();
          await initializePosition();
        });
      });
    });
  }

  // controls switching between pages
  int _selectedIndex = 0;
  final _pageController = PageController(
    initialPage: 0,
  );

  @override
  void initState() {    
    super.initState();

    _requestAllPermissions();
  }

  @override
  void dispose() async {
    await _player.dispose();
    await TorchLight.disableTorch();
    await _porcupineManager.delete();

    super.dispose();
  }

  @override
  Widget build(BuildContext context) {

    return MaterialApp(
      theme: ThemeData( // app theme
        colorScheme: const ColorScheme.light(
          primary: Colors.red,
          secondary: Colors.black,
        ),
        appBarTheme: const AppBarTheme(
          centerTitle: true,
          backgroundColor: Colors.red,
          foregroundColor: Colors.white,
        ),
        outlinedButtonTheme: const OutlinedButtonThemeData(
          style: ButtonStyle(
            foregroundColor: MaterialStatePropertyAll( Colors.black ),
          ),
        ),
        elevatedButtonTheme: const ElevatedButtonThemeData(
          style: ButtonStyle(
            foregroundColor: MaterialStatePropertyAll( Colors.white ),
            backgroundColor: MaterialStatePropertyAll( Colors.red ),
          ),
        ),
        textButtonTheme: const TextButtonThemeData(
          style: ButtonStyle(
            foregroundColor: MaterialStatePropertyAll( Colors.red ),
          )
        ),
        floatingActionButtonTheme: const FloatingActionButtonThemeData(
          foregroundColor: Colors.white,
          backgroundColor: Colors.red,
        ),
        progressIndicatorTheme: const ProgressIndicatorThemeData(
          color: Colors.red,
        ),
        inputDecorationTheme: const InputDecorationTheme(
          floatingLabelStyle: TextStyle( color: Colors.black ),
          focusedBorder: UnderlineInputBorder( borderSide: BorderSide( color: Colors.black ), ),
        ),
        textSelectionTheme: const TextSelectionThemeData(
          cursorColor: Colors.black,
        ),
        navigationBarTheme: NavigationBarThemeData(
          backgroundColor: Colors.red,
          indicatorColor: Colors.white,
          labelTextStyle: MaterialStateProperty.resolveWith&lt;TextStyle&gt;(
            ( Set&lt;MaterialState&gt; states ) {
              return TextStyle(
                color: states.contains( MaterialState.selected ) ? Colors.white : Colors.black,
              );
            },
          ),
          iconTheme: MaterialStateProperty.resolveWith&lt;IconThemeData&gt;(
            ( Set&lt;MaterialState&gt; states ) {
              return IconThemeData(
                color: states.contains( MaterialState.selected ) ? Colors.red : Colors.black,
              );
            },
          ),
        ),
        dropdownMenuTheme: const DropdownMenuThemeData(
          menuStyle: MenuStyle(
            backgroundColor: MaterialStatePropertyAll( Colors.white ),
          ),
        ),
        sliderTheme: const SliderThemeData(
          activeTrackColor: Colors.red,
          inactiveTrackColor: Colors.black,
        ),
        snackBarTheme: const SnackBarThemeData(
          backgroundColor: Colors.white,
          actionTextColor: Colors.red,
          contentTextStyle: TextStyle(
            color: Colors.black,
          ),
          behavior: SnackBarBehavior.floating,
        ),
        switchTheme: SwitchThemeData(
          trackColor: MaterialStateProperty.resolveWith&lt;Color?&gt;(
            ( Set&lt;MaterialState&gt; states ) {
              return states.contains( MaterialState.selected ) ? Colors.red : null;
            },
          ),
        ),
      ),
      debugShowCheckedModeBanner: false,
      home: Scaffold(
        appBar: AppBar(
          title: const Text(&#34;InstaHelp&#34;),
        ),
        body: PageView(
          controller: _pageController,
          onPageChanged: (changedIndex) =&gt; setState( () =&gt; _selectedIndex = changedIndex ),
          children: [ // pages shown in app
            const ProfilePage(),
            _mapPermStatus.isGranted &amp;&amp; _micPermStatus.isGranted &amp;&amp; _smsPermStatus.isGranted ?
            _homePage() : _permissionRequestPage(),
            const MapPage(),
          ],
        ),
        bottomNavigationBar: NavigationBar(
          onDestinationSelected: (changedIndex) {
            setState( () =&gt; _selectedIndex = changedIndex );
            _pageController.jumpToPage(changedIndex);
          },
          selectedIndex: _selectedIndex,
          destinations: const [
            NavigationDestination(
              icon: Icon( Icons.person ),
              label: &#34;Profile&#34;,
            ),
            NavigationDestination(
              icon: Icon( Icons.home ),
              label: &#34;InstaHelp&#34;,
            ),
            NavigationDestination(
              icon: Icon( Icons.map ),
              label: &#34;Map&#34;,
            ),
          ],          
        ),
      ),
    );
  }

  Widget _homePage() {
    return Scaffold(
      body: Center( child: Text( _message, style: const TextStyle( fontSize: 36 ), ), ),
      floatingActionButton: FloatingActionButton(
        child: _muted ? const Icon( Icons.mic_off ) : const Icon( Icons.mic ),
        onPressed: () async {
          setState(() {
            _muted = !_muted;
            _message = _muted ? &#34;Glad you&#39;re safe!&#34; : &#34;We&#39;re ready to help!&#34;;
          });
          if( _muted ) {
            await _porcupineManager.stop();
            _player.stop();
            await TorchLight.disableTorch();
          } else {
            await _porcupineManager.start();
          }
        },
      ),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
    );
  }

  Widget _permissionRequestPage() {
    return Center(
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          const Text( &#34;Please grant all required permissions&#34; ),
          ElevatedButton(
            onPressed: () async =&gt; await _requestAllPermissions(),
            child: const Text( &#34;Request permissions and check status&#34; ),
          ),
          const Text( &#34;Alternatively, grant permissions from app settings&#34; ),
          ElevatedButton(
            onPressed: () async =&gt; await openAppSettings(),
            child: const Text( &#34;Grant permissions from app settings&#34; ),
          ),
        ],
      ),
    );
  }
}
</code></pre>
<p>map_page.dart</p>
<pre><code language="language-dart" class="language-dart">import &#39;package:flutter/material.dart&#39;;

import &#39;package:google_maps_flutter/google_maps_flutter.dart&#39;;

import &#39;package:geolocator/geolocator.dart&#39;;

import &#39;profile_page.dart&#39;;

// location handling
late Position currentPosition;

Future&lt;void&gt; initializePosition() async {
  bool serviceEnabled = await Geolocator.isLocationServiceEnabled();
  if( !serviceEnabled ) {
    return Future.error( &#34;Location services are disabled.&#34; );
  }

  LocationPermission permission = await Geolocator.checkPermission();

  if( permission == LocationPermission.denied ) {
    permission = await Geolocator.requestPermission();

    if( permission == LocationPermission.denied ) {
      return Future.error( &#34;Location permissions are denied.&#34; );
    }
  }

  if( permission == LocationPermission.deniedForever ) {
    return Future.error( &#34;Location permissions are permanently denied, we cannot request permissions.&#34; );
  }

  LocationAccuracyStatus accuracyStatus = await Geolocator.getLocationAccuracy();
  if( accuracyStatus == LocationAccuracyStatus.reduced ) {
    return Future.error( &#34;Location permissions are reduced, we need precise accuracy.&#34; );
  }

  await getPosition();
}

Future&lt;void&gt; getPosition() async {
  currentPosition = await Geolocator.getCurrentPosition();
}

// currenty hardcoded, nearby users will be a feature in the near future
Set&lt;Marker&gt; nearbyUsers = {
  // Marker(
  //   markerId: const MarkerId( &#34;Nearby user 1 (online and safe)&#34; ),
  //   icon: BitmapDescriptor.defaultMarkerWithHue( BitmapDescriptor.hueGreen ),
  //   position: LatLng( currentPosition.latitude + 0.01, currentPosition.longitude + 0.01 ),
  // ),
  // Marker(
  //   markerId: const MarkerId( &#34;Nearby user 2 (in danger)&#34; ),
  //   icon: BitmapDescriptor.defaultMarkerWithHue( BitmapDescriptor.hueRed ),
  //   position: LatLng( currentPosition.latitude - 0.01, currentPosition.longitude + 0.01 ),
  // ),
  // Marker(
  //   markerId: const MarkerId( &#34;Nearby user 3 (coming to help you)&#34; ),
  //   icon: BitmapDescriptor.defaultMarkerWithHue( BitmapDescriptor.hueBlue ),
  //   position: LatLng( currentPosition.latitude + 0.01, currentPosition.longitude - 0.01 ),
  // ),
  // Marker(
  //   markerId: const MarkerId( &#34;Nearby user 4 (offline)&#34; ),
  //   icon: BitmapDescriptor.defaultMarkerWithHue( BitmapDescriptor.hueViolet ),
  //   position: LatLng( currentPosition.latitude - 0.01, currentPosition.longitude - 0.01 ),
  // ),
};

class MapPage extends StatefulWidget {
  const MapPage({super.key});

  @override
  State&lt;MapPage&gt; createState() =&gt; _MapPageState();
}

class _MapPageState extends State&lt;MapPage&gt; with WidgetsBindingObserver {

  final _positionStream = Geolocator.getPositionStream();

  bool _includeMap = true;
  void _resetMap() {
    WidgetsBinding.instance.addPostFrameCallback( (duration) {
      if(mounted) {
        setState( () =&gt; _includeMap = true );
      }
    });
    if(mounted) {
      setState( () =&gt; _includeMap = false );
    }
  }

  @override
  initState() {
    super.initState();

    WidgetsBinding.instance.addObserver(this);
  }

  @override
  dispose() {
    WidgetsBinding.instance.removeObserver(this);

    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      _resetMap();
    }
  }

  @override
  Widget build( BuildContext context ) {
    return StreamBuilder&lt;Position&gt;(
      stream: _positionStream,
      builder: (context, snapshot) {

        double radiusInMiles = userData.getProximityDistance();
        bool enableSignal = userData.getAlertNearbyUsers();

        _positionStream.listen( (position) =&gt; currentPosition = position );
      
        return Scaffold(
          body: snapshot.hasData &amp;&amp; _includeMap ? GoogleMap(
            initialCameraPosition: CameraPosition(
              target: LatLng( currentPosition.latitude, currentPosition.longitude ),
              zoom: 12,
            ),
            myLocationEnabled: true,
            markers: nearbyUsers,
            circles: enableSignal ? {
              Circle( // map radius of nearby area for users to come help
                circleId: const CircleId( &#34;Nearby area&#34; ),
                fillColor: Colors.red.withOpacity(0.5),
                center: LatLng( currentPosition.latitude, currentPosition.longitude ),
                radius: radiusInMiles * 1609.34, // converts miles to meters
                strokeWidth: 1,
              ),
            } : {},
          ) :
          const Center( // loading screen
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                CircularProgressIndicator.adaptive(),
                Text( &#34;Loading nearby users&#34; ),
              ],
            ),
          ),
          floatingActionButton: FloatingActionButton(
            onPressed: () async {
              _resetMap();
              await getPosition();
            },
            child: const Icon( Icons.refresh ),
          ),
          floatingActionButtonLocation: FloatingActionButtonLocation.centerFloat,
        );
      },
    );
  }
}
</code></pre>
<p>profile_page.dart</p>
<pre><code language="language-dart" class="language-dart">import &#39;package:flutter/material.dart&#39;;

import &#39;package:instahelp/firebase_options.dart&#39;;

import &#39;package:cloud_firestore/cloud_firestore.dart&#39;;
import &#39;package:firebase_auth/firebase_auth.dart&#39; hide EmailAuthProvider;
import &#39;package:firebase_core/firebase_core.dart&#39;;
import &#39;package:firebase_ui_auth/firebase_ui_auth.dart&#39;;
import &#39;package:firebase_ui_oauth_google/firebase_ui_oauth_google.dart&#39;;

import &#39;package:flutter_native_contact_picker/flutter_native_contact_picker.dart&#39;;
import &#39;package:volume_controller/volume_controller.dart&#39;;

// Variables and functions related to Firebase
class FirebaseClass {

  late FirebaseFirestore db;
  late User currentUser;

  bool loggedIn = false;
  bool emailVerified = false;

  // initialize Firebase when first running app
  Future&lt;void&gt; initializeFirebase() async {
    await Firebase.initializeApp(
      options: DefaultFirebaseOptions.currentPlatform,
    );

    // immediately initialize connection to Firestore after Firebase connection made
    db = FirebaseFirestore.instance;
  }

  void loadFromFirestore() {

    // ensures Firestore operations only occur if a user is logged in
    if( !loggedIn ) return;

    // get current user&#39;s data
    db.collection( &#34;user_options&#34; ).doc( currentUser.uid ).get().then(
      (doc) {
        if( doc.data() == null ) {
          // newly created users get new document in Firestore with default data
          userData.resetData(&#34;all&#34;);
          db
            .collection( &#34;user_options&#34; )
            .doc( currentUser.uid )
            .set( userData.dataMap );
        } else {
          // existing users get their data stored in UserData as a map
          userData.dataMap = doc.data() as Map&lt;String, dynamic&gt;;
          userData.setTempVariables();
        }
      },
    );
  }

  // saves user data in Firestore when users presses save button in edit profile page
  void saveToFirestore() {
    userData.setDataMap();
    firebaseClass.db
      .collection( &#34;user_options&#34; )
      .doc( firebaseClass.currentUser.uid )
      .set( userData.dataMap );
  }
}

// User options from Firestore
class UserData {

  // user data in map structure for reading and writing to Firestore
  Map&lt;String, dynamic&gt; dataMap = {
    &#34;medicalInfo&#34; : true,
    &#34;bloodType&#34; : &#34;O+&#34;,
    &#34;alertNearbyUsers&#34; : true,
    &#34;proximityDistance&#34; : 5.0,
    &#34;textMessageAlert&#34; : true,
    &#34;emergencyContacts&#34; : [],
    &#34;soundAlarm&#34; : true,
    &#34;blinkFlashlight&#34; : true,
    &#34;blinkSpeed&#34; : 250.0,
  };

  // whether to send user&#39;s medical info when distress detected
  bool _medicalInfo = true;
  void setMedicalInfo( bool value ) =&gt; _medicalInfo = value;
  bool getMedicalInfo() =&gt; _medicalInfo;

  // blood type as part of user&#39;s medical info
  String _bloodType = &#34;O+&#34;;
  void setBloodType( String value ) =&gt; _bloodType = value;
  String getBloodType() =&gt; _bloodType;

  // whether to alert InstaHelp users close by to user
  bool _alertNearbyUsers = true;
  void setAlertNearbyUsers( bool value ) =&gt; _alertNearbyUsers = value;
  bool getAlertNearbyUsers() =&gt; _alertNearbyUsers;

  // distance radius from user to alert nearby users in
  double _proximityDistance = 5.0;
  void setProximityDistance( double value ) =&gt; _proximityDistance = value;
  double getProximityDistance() =&gt; _proximityDistance;

  // whether to send a text message to designated emergency contacts
  bool _textMessageAlert = true;
  void setTextMessageAlert( bool value ) =&gt; _textMessageAlert = value;
  bool getTextMessageAlert() =&gt; _textMessageAlert;

  // emergency contacts to send text messages to when distress detected
  List&lt;dynamic&gt; _emergencyContacts = [];
  void setEmergencyContacts( List&lt;dynamic&gt; value ) =&gt; _emergencyContacts = value;
  List&lt;dynamic&gt; getEmergencyContacts() =&gt; _emergencyContacts;

  // whether to play a loud siren from user&#39;s phone when distress detected
  bool _soundAlarm = true;
  void setSoundAlarm( bool value ) =&gt; _soundAlarm = value;
  bool getSoundAlarm() =&gt; _soundAlarm;

  // whether to blink the user&#39;s phone flashlight when distress detected
  bool _blinkFlashlight = true;
  void setBlinkFlashlight( bool value ) =&gt; _blinkFlashlight = value;
  bool getBlinkFlashlight() =&gt; _blinkFlashlight;

  // how fast to blink the flashlight
  double _blinkSpeed = 250.0;
  void setBlinkSpeed( double value ) =&gt; _blinkSpeed = value;
  double getBlinkSpeed() =&gt; _blinkSpeed;

  void setTempVariables() {
    _medicalInfo = dataMap[&#34;medicalInfo&#34;];
    _bloodType = dataMap[&#34;bloodType&#34;];
    _alertNearbyUsers = dataMap[&#34;alertNearbyUsers&#34;];
    _proximityDistance = dataMap[&#34;proximityDistance&#34;];
    _textMessageAlert = dataMap[&#34;textMessageAlert&#34;];
    _emergencyContacts = dataMap[&#34;emergencyContacts&#34;];
    _soundAlarm = dataMap[&#34;soundAlarm&#34;];
    _blinkFlashlight = dataMap[&#34;blinkFlashlight&#34;];
    _blinkSpeed = dataMap[&#34;blinkSpeed&#34;];
  }

  void setDataMap() {
    dataMap[&#34;medicalInfo&#34;] = _medicalInfo;
    dataMap[&#34;bloodType&#34;] = _bloodType;
    dataMap[&#34;alertNearbyUsers&#34;] = _alertNearbyUsers;
    dataMap[&#34;proximityDistance&#34;] = _proximityDistance;
    dataMap[&#34;textMessageAlert&#34;] = _textMessageAlert;
    dataMap[&#34;emergencyContacts&#34;] = _emergencyContacts;
    dataMap[&#34;soundAlarm&#34;] = _soundAlarm;
    dataMap[&#34;blinkFlashlight&#34;] = _blinkFlashlight;
    dataMap[&#34;blinkSpeed&#34;] = _blinkSpeed;
  }

  // default values for newly created users
  void resetData(String field) {
    switch( field ) {
      case &#34;medicalInfo&#34;:
        _medicalInfo = true;
      case &#34;bloodType&#34;:
        _bloodType = &#34;O+&#34;;
      case &#34;alertNearbyUsers&#34;:
        _alertNearbyUsers = true;
      case &#34;proximityDistance&#34;:
        _proximityDistance = 5.0;
      case &#34;textMessageAlert&#34;:
        _textMessageAlert = true;
      case &#34;emergencyContacts&#34;:
        _emergencyContacts = [];
      case &#34;soundAlarm&#34;:
        _soundAlarm = true;
      case &#34;blinkFlashlight&#34;:
        _blinkFlashlight = true;
      case &#34;blinkSpeed&#34;:
        _blinkSpeed = 250.0;
      case &#34;all&#34;:
        _medicalInfo = true;
        _bloodType = &#34;O+&#34;;
        _alertNearbyUsers = true;
        _proximityDistance = 5.0;
        _textMessageAlert = true;
        _emergencyContacts = [];
        _soundAlarm = true;
        _blinkFlashlight = true;
        _blinkSpeed = 250.0;
    }
  }

}

FirebaseClass firebaseClass = FirebaseClass();
UserData userData = UserData();

class ProfilePage extends StatefulWidget {
  const ProfilePage({super.key});

  @override
  State&lt;ProfilePage&gt; createState() =&gt; _ProfilePageState();
}

class _ProfilePageState extends State&lt;ProfilePage&gt; {

  final _userDetection = FirebaseAuth.instance.authStateChanges();

  @override
  Widget build( BuildContext context ) {
    return StreamBuilder&lt;User?&gt;(
      stream: _userDetection,
      builder: (context, snapshot) {

        // get current user
        _userDetection.listen((User? user) {
          if( user == null ) {
            firebaseClass.loggedIn = false;
            firebaseClass.emailVerified = false;
          } else {
            firebaseClass.loggedIn = true;
            firebaseClass.currentUser = user;
            firebaseClass.emailVerified = firebaseClass.currentUser.emailVerified;
          }
          firebaseClass.loadFromFirestore();
        });
      
        return firebaseClass.loggedIn ? ProfileScreen( // profile screen to show when user already logged in
          showUnlinkConfirmationDialog: true,
          showDeleteConfirmationDialog: true,
          // showMFATile: true, // temporarily disabled to prevent firebase premium charges
          actions: [
            SignedOutAction((context) {
              // reset user data to default upon sign out
              userData.resetData(&#34;all&#34;);
              userData.setDataMap();
            }),
            AccountDeletedAction( (context, user) async {
              // delete user options from firebase when account deleted
              await firebaseClass.db.collection(&#34;user_options&#34;).doc(user.uid).delete();
            }),
          ],
          children: [
            ElevatedButton( // edit profile button doubles as email verification button
              onPressed: () async {

                if( firebaseClass.emailVerified ) {
                  Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (context) {
                        userData.setTempVariables();
                        return const EditProfilePage();
                      },
                    ),
                  );
                } else {
                  await firebaseClass.currentUser.reload();
                  firebaseClass.currentUser = FirebaseAuth.instance.currentUser as User;
                  setState( () =&gt; firebaseClass.emailVerified = firebaseClass.currentUser.emailVerified );

                  if(!mounted) return;

                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(
                      content: Text(
                        firebaseClass.emailVerified ?
                        &#34;Email successfully verified!&#34; :
                        &#34;Email still not yet verified&#34;
                      ),
                      action: SnackBarAction(
                        label: &#34;OK&#34;,
                        onPressed: () {},
                      ),
                    ),
                  );
                }
              },
              child: Center(
                child: Text(
                  firebaseClass.emailVerified ?
                  &#34;Edit profile&#34; :
                  &#34;Check email verification status&#34;
                ),
              ),
            ),
          ],
        ) :
        SignInScreen( // sign in screen to show when no one logged in
          providers: [
            EmailAuthProvider(),
            GoogleProvider( clientId: &#34;&#34; ),
          ],
          showPasswordVisibilityToggle: true,
          footerBuilder: (context, action) {
            return const Center( child: Text( &#34;InstaHelp accounts are completely optional&#34; ) );
          },
        );
      },
    );
  }
}

class EditProfilePage extends StatefulWidget {
  const EditProfilePage({super.key});

  @override
  State&lt;EditProfilePage&gt; createState() =&gt; EditProfilePageState();
}

class EditProfilePageState extends State&lt;EditProfilePage&gt; {

  double _volumeListenerValue = 0;
  double _setVolumeValue = 0;

  final _contactPicker = FlutterContactPicker();
  final _volumeController = VolumeController();

  final _maxEmergencyContacts = 5;

  @override
  void initState() {
    super.initState();

    _volumeController.listener((volume) {
      setState( () =&gt; _volumeListenerValue = volume );
    });

    _volumeController.getVolume().then( (volume) =&gt; _setVolumeValue = volume );
  }

  @override
  void dispose() {
    _volumeController.removeListener();

    super.dispose();
  }

  @override
  Widget build( BuildContext context ) {

    return PopScope(
      onPopInvoked: (didPop) =&gt; firebaseClass.loadFromFirestore(),
      child: Scaffold(
        appBar: AppBar(
          automaticallyImplyLeading: false,
          title: const Text( &#34;Edit profile&#34; ),
        ),
        body: Center(
          child: ListView(
            shrinkWrap: true,
            children: [
              ListTile( // choose to send medical information
                title: const Text( &#34;Send medical information&#34; ),
                trailing: Switch(
                  value: userData.getMedicalInfo(),
                  onChanged: (value) {
                    setState( () =&gt; userData.setMedicalInfo(value) );
                  },
                ),
              ),
              Center(
                child: DropdownMenu( // selected blood type
                  enabled: userData.getMedicalInfo(),
                  label: Text( userData.getMedicalInfo() ? &#34;Select blood type&#34; : &#34;Disabled&#34; ),
                  initialSelection: userData.getMedicalInfo() ? userData.getBloodType() : &#34;Disabled&#34;,
                  onSelected: (value) =&gt; userData.setBloodType(value as String),
                  dropdownMenuEntries: const [
                    DropdownMenuEntry(
                      value: &#34;O+&#34;,
                      label: &#34;O+&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;O-&#34;,
                      label: &#34;O-&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;A+&#34;,
                      label: &#34;A+&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;A-&#34;,
                      label: &#34;A-&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;B+&#34;,
                      label: &#34;B+&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;B-&#34;,
                      label: &#34;B-&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;AB+&#34;,
                      label: &#34;AB+&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;AB-&#34;,
                      label: &#34;AB-&#34;,
                    ),
                    DropdownMenuEntry(
                      value: &#34;Disabled&#34;,
                      label: &#34;Disabled&#34;,
                      enabled: false,
                    ),
                  ],
                ),
              ),
              ListTile( // alert nearby users
                title: const Text( &#34;Alert nearby users (in future!)&#34; ),
                trailing: Switch(
                  value: userData.getAlertNearbyUsers(),
                  onChanged: (value) {
                    setState(() {
                      userData.setAlertNearbyUsers(value);
                      if( value == false ) {
                        userData.resetData(&#34;proximityDistance&#34;);
                      }
                    });
                  },
                ),
              ),
              Center(
                child: Text(
                  userData.getAlertNearbyUsers() ?
                  &#34;Proximity distance: &#34;
                  &#34;${userData.getProximityDistance()} &#34;
                  &#34;${userData.getProximityDistance() == 1 ? &#34;mile&#34; : &#34;miles&#34;}&#34; :
                  &#34;Location signal disabled&#34;
                ),
              ),
              Center(
                child: Slider( // proximity distance in miles
                  min: 1.0,
                  max: 10.0,
                  divisions: 18,
                  value: userData.getAlertNearbyUsers() ? userData.getProximityDistance() : 1.0,
                  onChanged: (value) {
                    if( userData.getAlertNearbyUsers() ) {
                      setState( () =&gt; userData.setProximityDistance(value) );
                    }
                  },
                  thumbColor: userData.getAlertNearbyUsers() ? Colors.red : Colors.black,
                ),
              ),
              ListTile( // send text message to designated emergency contacts
                title: const Text( &#34;Text message alert&#34; ),
                trailing: Switch(
                  value: userData.getTextMessageAlert(),
                  onChanged: (value) {
                    setState(() {
                      userData.setTextMessageAlert(value);
                      if( value == false ) {
                        userData.resetData(&#34;emergencyContacts&#34;);
                      }
                    });
                  },
                ),
              ),
              Center( // button to add emergency contacts
                child: ElevatedButton(
                  onPressed: () async {
                    if( userData.getTextMessageAlert() &amp;&amp; userData.getEmergencyContacts().length &lt; _maxEmergencyContacts ) {
                      Contact? value = await _contactPicker.selectContact();                                                            
                      if( value != null &amp;&amp; !userData.getEmergencyContacts().contains(value.toString()) ) {
                        setState( () =&gt; userData.getEmergencyContacts().add( value.toString() ) );
                      }
                    }
                  },
                  child: Text(
                    userData.getTextMessageAlert() ?
                    userData.getEmergencyContacts().length == _maxEmergencyContacts ?
                    &#34;Maximum $_maxEmergencyContacts emergency contacts&#34; :
                    &#34;Add new emergency contact&#34; :
                    &#34;Text message alert disabled&#34;
                  ),
                ),
              ),
              ListView.builder(
                shrinkWrap: true,
                physics: const ClampingScrollPhysics(),
                itemCount: userData.getEmergencyContacts().length,
                itemBuilder: (_, int index) {
                  return ListTile(
                    title: Text( userData.getEmergencyContacts()[index] ),
                    trailing: IconButton(
                      icon: const Icon( Icons.delete ),
                      onPressed: () {
                        setState( () =&gt; userData.getEmergencyContacts().remove( userData.getEmergencyContacts()[index] ) );
                      },
                    ),
                  );
                },
              ),
              ListTile( // play loud siren
                title: const Text( &#34;Sound alarm&#34; ),
                trailing: Switch(
                  value: userData.getSoundAlarm(),
                  onChanged: (value) {
                    setState(() {
                      userData.setSoundAlarm(value);
                      _volumeController.getVolume().then( (volume) =&gt; _setVolumeValue = volume );
                    });
                  },
                ),
              ),
              Center(
                child: Text(
                  userData.getSoundAlarm() ?
                  &#34;Phone volume: ${_volumeListenerValue == 0 ?
                  &#34;Muted&#34; :
                  &#34;${(_volumeListenerValue * 100).round()}%&#34; }&#34; :
                  &#34;Sound alarm disabled&#34;
                ),
              ),
              Center(
                child: Slider( // siren volume
                  min: 0,
                  max: 1,
                  value: userData.getSoundAlarm() ? _volumeListenerValue : 0,
                  onChanged: (value) {
                    if( userData.getSoundAlarm() ) {
                      setState(() {
                        _setVolumeValue = value;
                        _volumeController.setVolume(_setVolumeValue);
                      });
                    }
                  },
                  thumbColor: userData.getSoundAlarm() ? Colors.red : Colors.black,
                ),
              ),
              ListTile( // turn flashlight on and off like a blinker
                title: const Text( &#34;Blink flashlight&#34; ),
                trailing: Switch(
                  value: userData.getBlinkFlashlight(),
                  onChanged: (value) {
                    setState( () =&gt; userData.setBlinkFlashlight(value) );
                    if( value == false ) {
                      userData.resetData(&#34;blinkSpeed&#34;);
                    }
                  },
                ),
              ),
              Center(
                child: Text(
                  userData.getBlinkFlashlight() ?
                  &#34;Blink speed: ${ userData.getBlinkSpeed() == 1000 ?
                  &#34;1 second&#34; :
                  &#34;${userData.getBlinkSpeed().round()} milliseconds&#34; }&#34; :
                  &#34;Blink flashlight disabled&#34;
                ),
              ),
              Center(
                child: Slider( // proximity distance in miles
                  min: 100,
                  max: 1000,
                  divisions: 18,
                  value: userData.getBlinkFlashlight() ? userData.getBlinkSpeed() : 100.0,
                  onChanged: (value) {
                    if( userData.getBlinkFlashlight() ) {
                      setState( () =&gt; userData.setBlinkSpeed(value) );
                    }
                  },
                  thumbColor: userData.getBlinkFlashlight() ? Colors.red : Colors.black,
                ),
              ),
            ],
          ),
        ),
        bottomNavigationBar: NavigationBar(
          onDestinationSelected: (updatedIndex) {
      
            if( updatedIndex == 0 ) {
              firebaseClass.saveToFirestore();
            }
      
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text( updatedIndex == 0 ? &#34;Profile changes saved!&#34; : &#34;Profile changes discarded&#34; ),
                action: SnackBarAction(
                  label: &#34;OK&#34;,
                  onPressed: () {},
                ),
              ),
            );
      
            firebaseClass.loadFromFirestore();

            Navigator.pop(context);
          },
          destinations: const [
            NavigationDestination(
              icon: Icon( Icons.save ),
              label: &#34;Save&#34;,
            ),
            NavigationDestination(
              icon: Icon( Icons.delete ),
              label: &#34;Discard&#34;,
            ),
          ],
        ),
      ),
    );
  }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Submission Form Responses" duration="0">
        

      </google-codelab-step>
    
      <google-codelab-step label="Acknowledgements" duration="0">
        <p>Special thanks to the Google Developer Student Clubs at the University of South Florida</p>
<p>USF GDSC Community Page https://gdsc.community.dev/university-of-south-florida</p>
<p>Made with ðŸ’š ðŸ’› by Robin Sardja</p>
<p>My GDSC Profile https://gdsc.community.dev/u/mjvvwh</p>
<p>My Google Developers Profile https://g.dev/robinsardja</p>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/claat-public/native-shim.js"></script>
  <script src="https://storage.googleapis.com/claat-public/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/claat-public/prettify.js"></script>
  <script src="https://storage.googleapis.com/claat-public/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
